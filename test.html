<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Crash 验证器</title>
    <style>
        :root {
            --bg: #0b1220;
            --card: #0f1724;
            --muted: #9aa4b2;
            --accent: #00d1b2;
            --accent-dark: #00a88f;
            --glass: rgba(255, 255, 255, 0.03);
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(180deg, #071122 0%, #0b1220 100%);
            font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color: #e6eef6;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
            background: linear-gradient(90deg, var(--accent), var(--accent-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: var(--muted);
            max-width: 600px;
            margin: 0 auto;
        }

        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .card-header {
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .card-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .players-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .player-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .player-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--accent);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .field {
            display: flex;
            flex-direction: column;
        }

        .field label {
            font-size: 14px;
            color: var(--muted);
            margin-bottom: 6px;
            font-weight: 500;
        }

        .field input {
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
            color: inherit;
            font-size: 14px;
            transition: all 0.2s;
        }

        .field input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(0, 209, 178, 0.2);
        }

        .field input:disabled {
            background: rgba(255, 255, 255, 0.05);
            color: var(--muted);
            cursor: not-allowed;
        }

        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 24px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(90deg, var(--accent), var(--accent-dark));
            color: #021217;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 209, 178, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--muted);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .results-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 8px;
            overflow: hidden;
        }

        .result-table th {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px 16px;
            text-align: left;
            font-size: 14px;
            font-weight: 600;
            color: var(--muted);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .result-table td {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 14px;
        }

        .result-table tr:last-child td {
            border-bottom: none;
        }

        .multiplier {
            font-weight: 700;
            color: var(--warning);
        }

        .signature {
            word-break: break-all;
            font-family: monospace;
            font-size: 12px;
        }

        .hint {
            margin-top: 16px;
            color: var(--muted);
            font-size: 14px;
            text-align: center;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--muted);
        }

        .empty-state p {
            margin-bottom: 16px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .players-container {
                grid-template-columns: 1fr;
            }

            .results-container {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>Crash 验证器</h1>
        <p>对战游戏的 hash / salt 验证工具 —— 从URL参数自动填充数据并验证历史结果</p>
    </div>

    <div class="card">
        <div class="card-header">
            <h2>玩家信息</h2>
        </div>

        <div class="players-container">
            <div class="player-card">
                <div class="player-name" id="player1Name">玩家一</div>
                <div class="form-grid">
                    <div class="field">
                        <label for="player1Sign">签名</label>
                        <input disabled id="player1Sign" type="text" value=""/>
                    </div>
                    <div class="field">
                        <label for="player1Hash">区块哈希</label>
                        <input disabled id="player1Hash" type="text" value=""/>
                    </div>
                </div>
            </div>

            <div class="player-card">
                <div class="player-name" id="player2Name">玩家二</div>
                <div class="form-grid">
                    <div class="field">
                        <label for="player2Sign">签名</label>
                        <input disabled id="player2Sign" type="text" value=""/>
                    </div>
                    <div class="field">
                        <label for="player2Hash">区块哈希</label>
                        <input disabled id="player2Hash" type="text" value=""/>
                    </div>
                </div>
            </div>
        </div>

        <div class="field" style="max-width: 200px;">
            <label for="count">验证轮数</label>
            <input id="count" type="number" value="5" min="1" max="100"/>
        </div>

        <div class="controls">
            <button id="verifyBtn" class="btn btn-primary">
                <span>验证结果</span>
            </button>
            <button id="clearBtn" class="btn btn-secondary">清除结果</button>
            <div style="margin-left: auto; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 14px; color: var(--muted);">结果格式：</span>
                <span style="font-size: 14px;">签名 → Bust</span>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2>验证结果</h2>
        </div>

        <div class="results-container">
            <div>
                <h3 style="margin-bottom: 12px; font-size: 16px; color: var(--accent);" id="player1ResultTitle">玩家一结果</h3>
                <table class="result-table">
                    <thead>
                    <tr>
                        <th>签名</th>
                        <th>Bust</th>
                    </tr>
                    </thead>
                    <tbody id="t1body">
                    <tr>
                        <td colspan="2" class="empty-state">
                            <p>暂无数据</p>
                            <p style="font-size: 12px;">点击"验证结果"开始计算</p>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div>
                <h3 style="margin-bottom: 12px; font-size: 16px; color: var(--accent);" id="player2ResultTitle">玩家二结果</h3>
                <table class="result-table">
                    <thead>
                    <tr>
                        <th>签名</th>
                        <th>Bust</th>
                    </tr>
                    </thead>
                    <tbody id="t2body">
                    <tr>
                        <td colspan="2" class="empty-state">
                            <p>暂无数据</p>
                            <p style="font-size: 12px;">点击"验证结果"开始计算</p>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="hint">
        注意：本页面只是界面与本地演示，计算规则与原站点可能不同。若需完全一致的验证算法，请提供原站点的算法或允许我抓取并复现。
    </div>
</div>

<script type="module">
    import bs58 from "https://cdn.jsdelivr.net/npm/bs58@5.0.0/+esm";

    // 获取URL参数
    function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
            player1Name: params.get('player1Name'),
            player2Name: params.get('player2Name'),
            player1Sign: params.get('player1Sign'),
            player1Hash: params.get('player1Hash'),
            player2Sign: params.get('player2Sign'),
            player2Hash: params.get('player2Hash'),
        };
    }

    // SHA-256 哈希函数
    async function hashData(data) {
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        return new Uint8Array(hashBuffer);
    }

    // 归一化函数
    async function normalizeHash(decoded) {
        try {
            const hashArray = Array.from(decoded);
            let hashValue = 0n;

            for (const byte of hashArray) {
                hashValue = (hashValue << 8n) + BigInt(byte);
            }

            const maxValue = (1n << 256n) - 1n;
            const normalized = Number(hashValue) / Number(maxValue);
            return normalized;
        } catch (e) {
            console.error('归一化错误:', e);
            return 0;
        }
    }

    // 创建结果表格行
    function createResultRow(signature, bust, isPlayer1 = true) {
        const tbody = isPlayer1 ? document.getElementById('t1body') : document.getElementById('t2body');

        // 移除空状态
        if (tbody.querySelector('.empty-state')) {
            tbody.innerHTML = '';
        }

        const tr = document.createElement('tr');

        const signatureCell = document.createElement('td');
        signatureCell.textContent = signature;
        signatureCell.className = 'signature';

        const bustCell = document.createElement('td');
        bustCell.textContent = `${bust.toFixed(4)}x`;
        bustCell.className = 'multiplier';

        tr.appendChild(signatureCell);
        tr.appendChild(bustCell);
        tbody.appendChild(tr);

        return tr;
    }

    // 验证函数
    async function verifyGames(player1Sign, player1Hash, player2Sign, player2Hash, count) {
        const verifyBtn = document.getElementById('verifyBtn');
        const t1body = document.getElementById('t1body');
        const t2body = document.getElementById('t2body');

        // 设置加载状态
        verifyBtn.disabled = true;
        verifyBtn.innerHTML = '<div class="loading"></div><span>验证中...</span>';

        // 清空之前的结果
        t1body.innerHTML = '';
        t2body.innerHTML = '';

        try {
            // 解码Base58
            const decoded1Sign = bs58.decode(player1Sign);
            const decoded1Hash = bs58.decode(player1Hash);
            const decoded2Sign = bs58.decode(player2Sign);
            const decoded2Hash = bs58.decode(player2Hash);

            // 合并字节数组
            let player1Combined = new Uint8Array(decoded1Sign.length + decoded1Hash.length);
            let player2Combined = new Uint8Array(decoded2Sign.length + decoded2Hash.length);

            player1Combined.set(decoded1Sign, 0);
            player1Combined.set(decoded1Hash, decoded1Sign.length);
            player2Combined.set(decoded2Sign, 0);
            player2Combined.set(decoded2Hash, decoded2Sign.length);

            // 计算多轮结果
            for (let i = 0; i < count; i++) {
                player1Combined = await hashData(player1Combined);
                player2Combined = await hashData(player2Combined);

                const player1Signature = bs58.encode(player1Combined);
                const player2Signature = bs58.encode(player2Combined);

                const player1Bust = await normalizeHash(player1Combined);
                const player2Bust = await normalizeHash(player2Combined);

                createResultRow(player1Signature, player1Bust, true);
                createResultRow(player2Signature, player2Bust, false);
            }
        } catch (error) {
            console.error('验证错误:', error);
            alert('验证过程中发生错误: ' + error.message);
        } finally {
            // 恢复按钮状态
            verifyBtn.disabled = false;
            verifyBtn.innerHTML = '<span>验证结果</span>';
        }
    }

    // 更新页面数据
    function updatePage() {
        const params = getUrlParams();

        // 更新玩家名称
        if (params.player1Name) {
            document.getElementById('player1Name').textContent = `玩家一: ${params.player1Name}`;
            document.getElementById('player1ResultTitle').textContent = `${params.player1Name} 结果`;
        }

        if (params.player2Name) {
            document.getElementById('player2Name').textContent = `玩家二: ${params.player2Name}`;
            document.getElementById('player2ResultTitle').textContent = `${params.player2Name} 结果`;
        }

        // 更新输入框值
        if (params.player1Sign) {
            document.getElementById('player1Sign').value = params.player1Sign;
        }

        if (params.player1Hash) {
            document.getElementById('player1Hash').value = params.player1Hash;
        }

        if (params.player2Sign) {
            document.getElementById('player2Sign').value = params.player2Sign;
        }

        if (params.player2Hash) {
            document.getElementById('player2Hash').value = params.player2Hash;
        }
    }

    // 初始化页面
    function initPage() {
        updatePage();

        const verifyBtn = document.getElementById('verifyBtn');
        const clearBtn = document.getElementById('clearBtn');
        const countInput = document.getElementById('count');

        // 验证按钮点击事件
        verifyBtn.addEventListener('click', async () => {
            const params = getUrlParams();

            // 验证必填字段
            if (!params.player1Sign || !params.player1Hash || !params.player2Sign || !params.player2Hash) {
                alert('请确保URL中包含所有必需的参数: player1Sign, player1Hash, player2Sign, player2Hash');
                return;
            }

            const count = parseInt(countInput.value) || 5;
            await verifyGames(
                params.player1Sign,
                params.player1Hash,
                params.player2Sign,
                params.player2Hash,
                count
            );
        });

        // 清除按钮点击事件
        clearBtn.addEventListener('click', () => {
            document.getElementById('t1body').innerHTML = `
                    <tr>
                        <td colspan="2" class="empty-state">
                            <p>暂无数据</p>
                            <p style="font-size: 12px;">点击"验证结果"开始计算</p>
                        </td>
                    </tr>
                `;

            document.getElementById('t2body').innerHTML = `
                    <tr>
                        <td colspan="2" class="empty-state">
                            <p>暂无数据</p>
                            <p style="font-size: 12px;">点击"验证结果"开始计算</p>
                        </td>
                    </tr>
                `;
        });

        // 输入框回车触发验证
        countInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                verifyBtn.click();
            }
        });
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', initPage);
</script>
</body>
</html>